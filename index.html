<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>车辆系统</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/4.2.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.default.css" id="theme-stylesheet">
    <link rel="stylesheet" type="text/css" href="css/verify.css">
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>

<body>
<div class="customer">
    <div class="customer_top">
        <a href="javascript:;" class="two_sel" id="solutiont1"
           onMouseOver="hoverlia4('solutiont', 'solutiondiv', 1, 2,'two_sel')">车辆入场</a>
        <a href="javascript:;" id="solutiont2"
           onMouseOver="hoverlia4('solutiont', 'solutiondiv', 2, 2,'two_sel')">车辆出场</a>
    </div>
    <div id="solutiondiv1">
        <!--
            accept="image/*" 规定上传文件的类型，只支持图片
            capture="camera" 打开系统照相机进行拍照，触发
            onchange事件
          -->
        <div class="upload-file" id="upload-file">
            <input type="file" id="file" accept="image/*" onchange="getImageFile(event)" capture="camera">
        </div>
        <div style="margin-top: -200px">
            <img id='img' style="height: 200px;width: 96%;margin-left: 2%;">
        </div>
        <div id="carLicenseBox">
            <div class="carLicenseTitle">
                车牌号
            </div>
            <div class="carLicenseMain">
                <ul>
                    <li class="active">省</li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                </ul>
            </div>
            <div>
                <button>自动识别</button>
                <button >入场</button>
            </div>
            <div class="foot" style="display: none;"></div>
        </div>
    </div>
    <div id="solutiondiv2" class="divhidden" style="border: #1c7430 solid 1px">

    </div>
    <div id="keyboardBox">
        <div class="provienceBox" id="provienceBox">
            <div class="close">
                <div id="closeBox">关闭键盘</div>
            </div>
            <ul>
                <li>京</li>
                <li>津</li>
                <li>渝</li>
                <li>沪</li>
                <li>冀</li>
                <li>晋</li>
                <li>辽</li>
                <li>吉</li>
                <li>黑</li>
                <li>苏</li>
            </ul>
            <ul>
                <li>浙</li>
                <li>皖</li>
                <li>闽</li>
                <li>赣</li>
                <li>鲁</li>
                <li>豫</li>
                <li>鄂</li>
                <li>湘</li>
                <li>粤</li>
                <li>琼</li>
            </ul>
            <ul>
                <li>川</li>
                <li>贵</li>
                <li>云</li>
                <li>陕</li>
                <li>甘</li>
                <li>青</li>
                <li>蒙</li>
                <li>桂</li>
                <li>宁</li>
                <li>新</li>
            </ul>
            <ul>
                <li class="changeContentBtn other">ABC</li>
                <li>藏</li>
                <li>使</li>
                <li>领</li>
                <li>警</li>
                <li>学</li>
                <li>港</li>
                <li>澳</li>
                <li class="deleteBtn other">删除</li>
            </ul>
        </div>
        <div class="textBox" id="textBox">
            <div class="close">
                <div id="closeBox2">关闭键盘</div>
            </div>
            <ul>
                <li>1</li>
                <li>2</li>
                <li>3</li>
                <li>4</li>
                <li>5</li>
                <li>6</li>
                <li>7</li>
                <li>8</li>
                <li>9</li>
                <li>0</li>
            </ul>
            <ul>
                <li>Q</li>
                <li>W</li>
                <li>E</li>
                <li>R</li>
                <li>T</li>
                <li>Y</li>
                <li>U</li>
                <li>I</li>
                <li>O</li>
                <li>P</li>
            </ul>
            <ul>
                <li>A</li>
                <li>S</li>
                <li>D</li>
                <li>F</li>
                <li>G</li>
                <li>H</li>
                <li>J</li>
                <li>K</li>
                <li>L</li>
            </ul>
            <ul>
                <li class="changeContentBtn other">返回</li>
                <li>Z</li>
                <li>X</li>
                <li>C</li>
                <li>V</li>
                <li>B</li>
                <li>N</li>
                <li>M</li>
                <li class="deleteBtn other">删除</li>
            </ul>
        </div>
    </div>
</div>
<script src="https://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">
    //js tab功能
    function g(o) {
        return document.getElementById(o);
    }

    function hoverlia4(t_n, t_n2, n, k, className) {
        for (var i = 1; i <= k; i++) {
            g(t_n2 + i).className = 'divhidden';
            g(t_n + i).className = '';
        }
        g(t_n2 + n).className = 'container';
        g(t_n + n).className = className;
        setTimeout(function () {
            $("#" + t_n2 + n).find(".anim").addClass("anim-show");
        }, 6)
    }

    //合作客户翻页调用
    $(".customer-buttons div").click(function () {
        var linum = $(this).index();
        var CaseList = $(".customer_items .item");
        $(this).addClass('disabled').siblings().removeClass('disabled');
        CaseList.eq(linum).show().siblings().hide();
    });

    function getImageFile(e) {
        // FileReader 方法参考地址：https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader
        let reader = new FileReader();

        // readAsDataURL 方法参考地址：https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsDataURL
        reader.readAsDataURL(e.target.files[0]);
        // 监听读取操作结束
        reader.onloadend = function () {
            // 取出base64代码
            var dataURL = reader.result;
            // 赋值到图片上显示出来
            document.getElementById("img").src = dataURL;
            document.getElementById('upload-file').style.backgroundImage = 'none';
        };
    }

    $(document).ready(function () {
        //键盘隐藏，点击触发显示
        $("#keyboardBox").hide();
        $(".carLicenseMain").on("click", function () {
            $("#keyboardBox").show();
            // $(".foot").show()
            $("body,html").animate({scrollTop: 300}, 500);

        });

        $("#closeBox").on("click", function () {
            $("#keyboardBox").hide();
            $(".foot").hide()
        });

        $("#closeBox2").on("click", function () {
            $("#keyboardBox").hide();
            $(".foot").hide()
        });
        //键盘点击动画
        $(".textBox ul li").each(function () {
            $(this).click(function () {
                $(this).addClass("activeKey"); //添加动画效果
                $(this).siblings().removeClass("activeKey") //移除动画效果
                var interval = setTimeout(function () { //定时器及时清除自身动画效果
                    $(this).removeClass("activeKey")
                    window.clearInterval(interval)
                }.bind(this), 200);
            })
        });
        var num = 7; //需要输入的车牌数
        //切换键盘
        $('.changeContentBtn').click(function () {
            $('li').siblings().removeClass("activeKey")
            if ($(this).html() === 'ABC') {
                $('#textBox').show();
                $('#provienceBox').hide();
            } else {
                $('#textBox').hide();
                $('#provienceBox').show();
            }
        });
        //新能源点击事件
        $('.xinnengyuan').click(function () {
            num = 7;
            $(this).removeClass('xinnengyuan');
        });

        //获取当前车牌数字索引
        function getIndex() {
            if (localStorage.getItem('employ-coupon')) {
                var index = localStorage.getItem('employ-coupon').length;
                if (index > 7) {
                    index = 7
                }
                $('.carLicenseMain ul li').removeClass('active');
                $('.carLicenseMain ul ').find('li').eq(index).addClass('active');
                $('.carLicenseMain ul li').each(function () {
                    var reg = new RegExp('active');
                    if (reg.test($(this).attr('class'))) {
                        index = $(this).index();
                    }
                });
                localStorage.removeItem('employ-coupon');
                return index
            } else {
                var index = 0;
                $('.carLicenseMain ul li').each(function () {
                    var reg = new RegExp('active');
                    if (reg.test($(this).attr('class'))) {
                        index = $(this).index();
                    }
                });
                console.log(index);
                return index;
            }
        }

        //自定义键盘处理函数
        function keyboard(num, self) {
            var index = getIndex();
            if (index <= num) {
                if (index === num) {
                    $('.carLicenseMain ul li.active').html($(self).html());
                } else {
                    $('.carLicenseMain ul li.active').html($(self).html()).removeClass('active').next().addClass('active');
                }
                $('#textBox').show();
                $('#provienceBox').hide();
            }
        }

        //省份键盘点击事件
        $('#provienceBox ul li:not(.other)').click(function () {
            $(this).addClass("activeKey"); //添加动画效果
            $(this).siblings().removeClass("activeKey") //移除动画效果
            var interval = setTimeout(function () { //定时器及时清除自身动画效果
                $(this).removeClass("activeKey");
                var self = this;
                keyboard(num, self);
                window.clearInterval(interval)
            }.bind(this), 200);
            //省份点击后键盘切换
            //var self = this;
            //keyboard(num,self);
        });
        //文本键盘点击事件
        $('#textBox ul li:not(.other)').click(function () {
            var self = this;
            keyboard(num, self);
        });
        //回退按钮点击事件
        $('.deleteBtn').click(function () {
            var index = getIndex();
            if (index === num) {
                if ($('.carLicenseMain ul li.active').html() !== '') {
                    $('.carLicenseMain ul li.active').html('');
                } else {
                    if (index === 7) {
                        $('.carLicenseMain ul li:last-of-type').addClass('xinnengyuan');
                        num = 7;
                    }
                    $('.carLicenseMain ul li.active').removeClass('active').prev().addClass('active').html('');
                }
            } else if (index < num && index > 1) {
                $('.carLicenseMain ul li.active').removeClass('active').prev().addClass('active').html('');
            } else if (index === 1) {
                $('.carLicenseMain ul li.active').removeClass('active').prev().addClass('active').html('省');
            }
        });
        //提交按钮点击事件
        $('#submitBtn').click(function () {
            let countdown = 10;
            setTime(countdown);

            function setTime(countdown) {
                if (countdown === 0) {
                    document.getElementById('submitBtn').removeAttribute("disabled");
                    document.getElementById('submitBtn').innerHTML = "提交";
                } else {
                    document.getElementById('submitBtn').setAttribute("disabled", true);
                    document.getElementById('submitBtn').innerHTML = "提交中(" + countdown + ")";
                    countdown--;
                    setTimeout(function () {
                        setTime(countdown);
                    }, 1000)
                }
            }

            var carNum = "";
            var flag = true;
            $(".carLicenseMain ul li").each(function (index) {
                if (index !== 7) {
                    if ($(this).html() === "" || $(this).html() === undefined) {
                        flag = false;
                    }
                }
                carNum += $(this).html()
            });
            if (!flag) {
                alert("车牌录入不正确");
                return;
            }
            localStorage.setItem('employ-coupon', carNum);
            var id = getQueryVariable('id');
            var type = getQueryVariable('type');
            $.ajax({
                url: "http://api.jinshipark.com/yhq-war/couponOrderManager/insertCouponOrder",
                // url: "http://localhost:8080/couponOrderManager/insertCouponOrder",
                contentType: "charset=UTF-8",
                dataType: "json",
                type: "get",
                data: {
                    "plate": String(carNum),
                    "id": Number(id),
                    "type": Number(type)
                },
                success: function (data) {
                    if (data.msg === '使用优惠券成功') {
                        window.location.href = './success.html?carNum=' + encodeURIComponent(carNum) + '&type=' + type + '&id=' + id;
                    } else {
                        window.location.href = './error.html?carNum=' + encodeURIComponent(carNum) + '&type=' + type + '&id=' + id + '&msg=' + encodeURIComponent(data.msg);
                    }
                },
                error: function (data) {
                    msg = "系统异常";
                    window.location.href = './error.html?carNum=' + encodeURIComponent(carNum) + '&type=' + type + '&id=' + id + '&msg=' + encodeURIComponent(msg);
                },
            });

        })
    });
</script>

</body>

</html>